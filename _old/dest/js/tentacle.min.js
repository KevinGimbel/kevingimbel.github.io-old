var Tentacle=function(a,b,c){if(!a||-1==a.indexOf("http"))throw Error("Missing URL argument!");this.version="0.0.1",this.url=a,this.method=b||"GET",this.async=c||!0,this.response=null,this.responseText=null};Tentacle.prototype={get:function(a,b){if("function"!=typeof a)return console.log("Callback is not a function, please pass a function to Tentacle.get(), e.g."),console.info("Tentacle.get(function(response) { console.log(response)});"),!1;b||(b={});var c="GET",d=b.url||this.url,e=b.async||this.async,f=new XMLHttpRequest;f.open(c,d,e),f.onreadystatechange=function(){4==f.readyState&&200==f.status&&(this.response=f.response,a(this.response))}.bind(this),f.send()},post:function(a,b,c){if("function"!=typeof a)return console.log("Callback is not a function, please pass a function to Tentacle.get(), e.g."),console.info("Tentacle.get(function(response) { console.log(response)});"),!1;c||(c={});var d="POST",e=c.url||this.url,f=c.async||this.async,g=new XMLHttpRequest;g.open(d,e,f),g.onreadystatechange=function(){4==g.readyState&&200==g.status&&(this.response=g.response,a(this.response))}.bind(this),g.send(b)},render:function(a,b){for(var b=b,c=a,d="",e=c.length-1;e>=0;e--){var f=c[e],g=b.replace(/\{(.*?)\}/g,function(a,b){if(a.indexOf(".")>-1){var c=a.split("."),d=c[0].replace("{",""),e=c[1].replace("}","");return f[d][e]}return f[b]});d+=g}return d}};

document.addEventListener('DOMContentLoaded', function() {
var webmentionTemplate = '<article class="mention">' +
    '<h4><a href="{url}" title="{name}">{name}</a></h4>' +
    '<p>{content}</p>' +
    '</article>';


var webmentions = new Tentacle('http://webmention.io/api/mentions?target=http://indiewebcamp.com');

webmentions.get(function(response) {
  var res = JSON.parse(response).links;
  var cleanedRes = [];
  res.map(function(mention) {
    if(
      mention.data.url 
      && mention.data.content 
      && mention.data.name) {
      var url = mention.data.url;
      var name = mention.data.name;
      var content = mention.data.content;
      name = (name.length > 50) ? name.substr(0, 50) + '...' : name;
      content = (content.length > 250) ? content.substr(0,250) + '...' : content;
      
      var cleaned = {
          url: url,
          content: content,
          name: name
      }
      cleanedRes.push(cleaned);
    }
  });
  var mentions = webmentions.render(cleanedRes, webmentionTemplate);
  console.log(mentions);
  var output = document.querySelector('#mentions');
  output.innerHTML = mentions;
});

